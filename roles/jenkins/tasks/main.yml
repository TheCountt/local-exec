---
- name: install jenkins on debian OS
  include_tasks: debian.yml
  when: ansible_os_family == 'Debian'

- name: install jenkins on redhat OS
  include_tasks: redhat.yml
  when: ansible_os_family == 'Redhat'

# - name: install community module
#   shell: >
#    ansible-galaxy collection install community.postgresql
#   args:
#    creates: community.txt

- name: Install needed community modules
  community.general.ansible_galaxy_install:
    type: collection
    requirements_file: /home/ubuntu/anpbucket-ci-cd/requirements.yml


- name: Create group "docker"
  ansible.builtin.group:
    name: docker
    state: present


- name: Add user to group 'docker'
  ansible.builtin.user:
    name: ubuntu
    comment: Name of user to add to group docker
    group: docker


- name: Change file ownership, group and permissions
  ansible.builtin.file:
    path: /home/ubuntu/.docker
    owner: ubuntu
    group: ubuntu
    recurse: yes
    mode: '0666'

- name: Change file ownership, group and permissions
  ansible.builtin.file:
    path: /var/run/docker.sock
    mode: '0666'


- name: Start docker
  become: true
  ansible.builtin.systemd: 
    name: docker
    state: restarted
    enabled: yes
    daemon_reload: yes



# - name: install anchore engine
#   shell: >
#    curl https://engine.anchore.io/docs/quickstart/docker-compose.yaml > docker-compose.yaml
#   args:
#    creates: docker-compose.yaml

- name: get anchore engine
  ansible.builtin.get_url:
    url:  https://engine.anchore.io/docs/quickstart/docker-compose.yaml
    dest: $HOME/docker-compose.yaml
    mode: 0755

- name: start anchore engine
  community.docker.docker_compose:
    project_src: $HOME/spring-petclinic
    state: present