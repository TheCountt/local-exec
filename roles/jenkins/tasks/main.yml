---
- name: install jenkins on debian OS
  include_tasks: debian.yml
  when: ansible_os_family == 'Debian'

- name: install jenkins on redhat OS
  include_tasks: redhat.yml
  when: ansible_os_family == 'Redhat'


- name: Install needed community modules
  community.general.ansible_galaxy_install:
    type: collection
    requirements_file: ./anpbucket-ci-cd/requirements.yml

#  Refactor this block of code so that we do not need this
####################################
# - name: Create group "docker"
#   ansible.builtin.group:
#     name: docker
#     state: present


# - name: Add user to group 'docker'
#   ansible.builtin.user:
#     name: ubuntu
#     comment: Name of user to add to group docker
#     group: docker


# - name: Change file ownership, group and permissions
#   ansible.builtin.file:
#     path: ./.docker
#     owner: ubuntu
#     group: ubuntu
#     recurse: yes
#     mode: '0666'

# - name: Change file ownership, group and permissions
#   ansible.builtin.file:
#     path: /var/run/docker.sock
#     mode: '0666'
###################################################

- name: Start docker
  become: true
  ansible.builtin.systemd: 
    name: docker
    state: restarted
    enabled: yes
    daemon_reload: yes

# Anchore Engine for image scanning
- name: get anchore engine
  ansible.builtin.get_url:
    url:  https://engine.anchore.io/docs/quickstart/docker-compose.yaml
    dest: ./docker-compose.yaml
    mode: 0755

- name: start anchore engine
  community.docker.docker_compose:
    project_src: ./
    state: present